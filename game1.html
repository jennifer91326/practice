<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lights Outï½œç›Šæ™ºå°éŠæˆ²</title>
  <style>
    /*
      ===== ä¸»é¡Œè®Šæ•¸ / Theme Variables =====
      æ–¹ä¾¿çµ±ä¸€ç®¡ç†é¡è‰²ã€åœ“è§’ã€é™°å½±ç­‰è¨­è¨ˆèªè¨€ã€‚
    */
    :root{
      --bg: #0f1221;          /* èƒŒæ™¯åº•è‰² */
      --panel: #13162a;       /* å´é‚Šé¢æ¿åº•è‰² */
      --text: #e8ebff;        /* ä¸»è¦æ–‡å­—è‰² */
      --muted: #9aa3c7;       /* æ¬¡è¦/å¼±åŒ–æ–‡å­—è‰² */
      --accent: #6aa6ff;      /* è—è‰²å¼·èª¿ */
      --accent-2: #6affde;    /* ç¶ è‰²å¼·èª¿ */
      --danger: #ff6a8a;      /* å±éšª/è­¦ç¤ºç”¨è‰² */
      --on: #f9f871;          /* æ ¼å­ã€Œäº®ã€æ™‚çš„åº•è‰² */
      --off: #1f2341;         /* æ ¼å­ã€Œæš—ã€æ™‚çš„åº•è‰² */
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 10px rgba(0,0,0,.25);
      --radius: 18px;         /* å…¨åŸŸåœ“è§’åŠå¾‘ */
    }

    /* è®“ body å¯æ»¿é«˜ï¼Œé…åˆç½®ä¸­æ’ç‰ˆ */
    html,body{height:100%}

    /*
      èƒŒæ™¯ä½¿ç”¨å…©å±¤æ”¾å°„æ¼¸å±¤ï¼Œç‡Ÿé€ æ·±è‰²ç§‘å¹»æ„Ÿï¼›
      ä½¿ç”¨ flex å°‡ä¸»è¦å¡ç‰‡ç½®ä¸­é¡¯ç¤ºã€‚
    */
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 70% -20%, #1b2150 10%, transparent 60%),
                  radial-gradient(1000px 600px at 0% 120%, #162046 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }

    /* App å¤–å¡ç‰‡å®¹å™¨ */
    .app{ width:min(900px, 92vw); }

    /* å¡ç‰‡æ¨£å¼ï¼ˆæ¯›ç»ç’ƒæ„Ÿ + é‚Šæ¡† + é™°å½±ï¼‰ */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* æ¨™é ­ï¼šæ¨™é¡Œ + æ§åˆ¶åˆ— */
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:18px 22px; background: rgba(0,0,0,.15);
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    h1{ font-size: clamp(20px, 2.2vw, 28px); margin:0; letter-spacing:.5px; }
    .subtitle{ color: var(--muted); font-size: 12px; margin-top:4px; }

    /* æ§åˆ¶åˆ—ï¼ˆå°ºå¯¸ã€æŒ‰éˆ•ï¼‰ */
    .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .control{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 10px; border-radius: 12px;
    }

    /* è¡¨å–®å…ƒä»¶èˆ‡æŒ‰éˆ•çš„çµ±ä¸€å¤–è§€ */
    select, button, input[type="range"]{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background: #0f1431; color: var(--text); border:1px solid rgba(255,255,255,.12);
      padding:8px 10px; border-radius:12px; font-size:14px;
    }
    button{ cursor:pointer; transition: transform .05s ease, filter .2s ease; }
    button:active{ transform: translateY(1px); }
    .primary{ background: linear-gradient(180deg, rgba(106,166,255,.25), rgba(106,166,255,.15)); border-color:#86b8ff55; }
    .ghost{ background: transparent; border-color: rgba(255,255,255,.12); }
    .danger{ background: linear-gradient(180deg, rgba(255,106,138,.25), rgba(255,106,138,.15)); border-color:#ff9ab055; }

    /* çµ±è¨ˆè³‡è¨Šçš„å°è† å›Š */
    .stats{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px; font-size:13px; color: #d5dcff;
    }

    /*
      ä¸»è¦ç‰ˆé¢å€ï¼šå·¦å´èªªæ˜ + å³å´æ£‹ç›¤
      å°è¢å¹•æ™‚æ”¹ç‚ºå–®æ¬„æ’åˆ—ã€‚
    */
    main{ display:grid; grid-template-columns: 320px 1fr; gap:20px; padding:22px; }
    @media (max-width: 780px){ main{ grid-template-columns: 1fr; } }

    /* å·¦å´èªªæ˜é¢æ¿ */
    .left{ display:flex; flex-direction:column; gap:14px; }
    .panel{ background: var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px; }
    .panel h3{ margin:4px 0 12px; font-size:16px; color:#dbe1ff; }
    .howto ol{ margin:0 0 0 18px; padding:0; line-height:1.6; color:#c6cdee; font-size:14px; }
    .howto li+li{ margin-top:6px; }

    /* æ£‹ç›¤å¤–æ¡†èˆ‡èƒŒæ™¯è£é£¾ */
    .grid-wrap{ display:flex; align-items:center; justify-content:center; }
    .grid{
      display:grid; gap:10px; padding:16px; border-radius:20px;
      background: radial-gradient(400px 200px at 100% -10%, rgba(106,255,222,.08), transparent 60%),
                  radial-gradient(300px 200px at -20% 120%, rgba(106,166,255,.08), transparent 60%),
                  rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
    }

    /* æ£‹ç›¤æ ¼å­ï¼šç”¨ button ä»¥ä¾¿éµç›¤/ç„¡éšœç¤™äº’å‹•ï¼ˆä¹Ÿè¨­ aria å±¬æ€§ï¼‰ */
    .cell{
      width: clamp(42px, 8.5vw, 64px); height: clamp(42px, 8.5vw, 64px);
      border-radius: 14px; display:grid; place-items:center; font-weight:700;
      user-select:none; -webkit-tap-highlight-color: transparent;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.2), 0 2px 6px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
      transition: transform .06s ease, filter .15s ease, background .15s ease, box-shadow .2s ease;
      cursor:pointer;
    }
    .cell:active{ transform: translateY(1px); }
    .cell.on{  /* äº®ï¼šé»ƒè‰² + é«˜å…‰ */
      background: radial-gradient(140px 100px at 50% 30%, #fff6, transparent 60%), var(--on);
      color:#202020; text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .cell.off{ /* æš—ï¼šæ·±è— + ä½å½©åº¦æ–‡å­— */
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.25)), var(--off);
      color:#92a0d8;
    }

    /* åº•éƒ¨è¨Šæ¯åˆ— + é›£åº¦æ»‘æ¡¿ */
    .footer{ padding:16px 22px; border-top:1px solid rgba(255,255,255,.06); display:flex; align-items:center; justify-content:space-between; gap:10px; background: rgba(0,0,0,.1); }
    .msg{ color:#cfe4ff; font-size:14px; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="app card" id="app">
    <header>
      <div>
        <h1>Lights Outï½œé—œç‡ˆè§£è¬</h1>
        <div class="subtitle">é»æ“Šä¸€æ ¼æœƒåˆ‡æ›è©²æ ¼èˆ‡ä¸Šä¸‹å·¦å³çš„ç‡ˆï¼Œè®“ç‰ˆé¢å…¨éƒ¨é—œç‡ˆå³ç²å‹ã€‚</div>
      </div>
      <div class="controls">
        <div class="control">
          <label for="size">å°ºå¯¸</label>
          <!-- ç›¤é¢å¤§å°é¸æ“‡å™¨ï¼šæœƒé‡å»ºæ£‹ç›¤ -->
          <select id="size">
            <option value="3">3Ã—3</option>
            <option value="4">4Ã—4</option>
            <option value="5" selected>5Ã—5</option>
            <option value="6">6Ã—6</option>
            <option value="7">7Ã—7</option>
          </select>
        </div>
        <!-- æ–°å±€ï¼šå¾è§£å®Œç‹€æ…‹éš¨æ©Ÿæ‡‰ç”¨ K æ¬¡æœ‰æ•ˆæ­¥é©Ÿï¼Œä¿è­‰å¯è§£ -->
        <button id="new" class="primary">æ–°å±€ / æ´—ç‰Œ</button>
        <!-- å›å¾©åˆ°é–‹å±€æ™‚çš„ç›¤é¢ï¼ˆä¸é‡æ–°æ´—ï¼‰ -->
        <button id="reset" class="ghost">å›åˆ°èµ·å§‹</button>
        <!-- æç¤ºï¼šè‡ªå‹•åŸ·è¡Œä¸€æ­¥ï¼ˆæœƒè¨˜æ­¥ï¼‰ -->
        <button id="solve" class="danger">æç¤ºä¸€æ­¥</button>
      </div>
    </header>

    <main>
      <!-- å·¦å´ï¼šçµ±è¨ˆèˆ‡ç©æ³•èªªæ˜ -->
      <section class="left">
        <div class="panel">
          <h3>ç´€éŒ„</h3>
          <div class="stats">
            <span class="chip">æ­¥æ•¸ï¼š<b id="moves">0</b></span>
            <span class="chip">æ™‚é–“ï¼š<b id="time">00:00</b></span>
            <span class="chip">æœ€ä½³ï¼š<b id="best">â€”</b></span>
          </div>
        </div>
        <div class="panel howto">
          <h3>ç©æ³•</h3>
          <ol>
            <li>é»æ“Šä»»ä¸€æ ¼ï¼Œè©²æ ¼èˆ‡ä¸Šä¸‹å·¦å³æœƒä¸€èµ·åˆ‡æ›ã€Œäº®/æš—ã€ã€‚</li>
            <li>è®“æ‰€æœ‰æ ¼å­éƒ½è®Šæš—ï¼ˆé—œç‡ˆï¼‰å³å¯éé—œã€‚</li>
            <li>æŒ‰ã€Œæ–°å±€ã€å¯éš¨æ©Ÿç”¢ç”Ÿ <em>ä¿è­‰å¯è§£</em> çš„ç›¤é¢ï¼›ã€Œå›åˆ°èµ·å§‹ã€å¯æ’¤éŠ·åˆ°é–‹å±€ç‹€æ…‹ã€‚</li>
            <li>æŒ‰ã€Œæç¤ºä¸€æ­¥ã€æœƒå¥—ç”¨ä¸€å€‹æ­£ç¢ºæ­¥é©Ÿï¼ˆæœƒè¨ˆå…¥æ­¥æ•¸ï¼‰ã€‚</li>
          </ol>
        </div>
      </section>

      <!-- å³å´ï¼šæ£‹ç›¤å€ -->
      <section class="grid-wrap">
        <div id="grid" class="grid" role="grid" aria-label="Lights Out Grid"></div>
      </section>
    </main>

    <!-- åº•éƒ¨ç‹€æ…‹è¨Šæ¯èˆ‡äº‚æ•¸å¯†åº¦ï¼ˆè¶Šå¤§è¶Šäº‚ï¼‰ -->
    <div class="footer">
      <div class="msg" id="msg">ç¥ä½ å¥½é‹ï¼</div>
      <div style="display:flex; gap:8px; align-items:center">
        <label for="density">äº‚æ•¸é›£åº¦</label>
        <input id="density" type="range" min="1" max="10" step="1" value="6" />
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // å·¥å…·å‡½å¼ / Utilities
    // ==========================
    const pad = (n)=> n.toString().padStart(2,'0'); // è£œé›¶ï¼š5 -> "05"

    // ==========================
    // ç‹€æ…‹è®Šæ•¸ / Game State
    // ==========================
    const gridEl = document.getElementById('grid');
    const sizeSel = document.getElementById('size');
    const newBtn = document.getElementById('new');
    const resetBtn = document.getElementById('reset');
    const solveBtn = document.getElementById('solve');
    const movesEl = document.getElementById('moves');
    const timeEl = document.getElementById('time');
    const bestEl = document.getElementById('best');
    const msgEl = document.getElementById('msg');
    const densityEl = document.getElementById('density');

    let N = parseInt(sizeSel.value, 10); // ç›¤é¢å¯¬é«˜ï¼ˆNÃ—Nï¼‰
    let board = [];          // ç›®å‰ç›¤é¢ï¼š0=æš—, 1=äº®
    let startBoard = [];     // é–‹å±€ç›¤é¢ï¼ˆç”¨æ–¼ resetï¼‰
    let moves = 0;           // æ­¥æ•¸
    let timer = 0;           // ç¶“éç§’æ•¸
    let tick = null;         // setInterval çš„ id
    let started = false;     // æ˜¯å¦å·²ç¶“é–‹å§‹è¨ˆæ™‚

    // ä¾ç›¤é¢å°ºå¯¸å­˜æ”¾ã€Œæœ€ä½³ç´€éŒ„ã€çš„ localStorage key
    const key = (n)=> `lightsout-best-${n}`;

    function getBest(n){
      try{ return JSON.parse(localStorage.getItem(key(n)) || 'null'); }catch{ return null; }
    }
    function setBest(n, val){
      try{ localStorage.setItem(key(n), JSON.stringify(val)); }catch{}
    }

    // å°‡æœ€ä½³ç´€éŒ„é¡¯ç¤ºåˆ°ç•«é¢ï¼ˆè‹¥ç„¡å‰‡é¡¯ç¤º em dashï¼‰
    function updateBestUI(){
      const b = getBest(N);
      bestEl.textContent = b? `${b.moves}æ­¥ï½œ${b.time}` : 'â€”';
    }

    // å°‡ç§’æ•¸æ ¼å¼åŒ–ç‚º mm:ss
    function fmtTime(sec){
      const m = Math.floor(sec/60), s = sec%60; return `${pad(m)}:${pad(s)}`;
    }

    function startTimer(){
      if(tick) return; // å·²æœ‰è¨ˆæ™‚å™¨å°±ä¸é‡è¤‡å•Ÿå‹•
      tick = setInterval(()=>{ timer++; timeEl.textContent = fmtTime(timer); }, 1000);
    }
    function stopTimer(){ if(tick){ clearInterval(tick); tick=null; } }

    // ä¾ N å»ºç«‹æ£‹ç›¤ DOMï¼Œä¸¦æ›ä¸Šé»æ“Šäº‹ä»¶
    function buildGrid(){
      gridEl.innerHTML = '';
      gridEl.style.gridTemplateColumns = `repeat(${N}, 1fr)`;
      gridEl.style.gridTemplateRows = `repeat(${N}, 1fr)`;
      for(let r=0;r<N;r++){
        for(let c=0;c<N;c++){
          const cell = document.createElement('button');
          cell.className = 'cell off';
          cell.setAttribute('role','gridcell');
          cell.setAttribute('aria-label',`row ${r+1} col ${c+1}`);
          cell.dataset.r = r; cell.dataset.c = c; // æ–¹ä¾¿é™¤éŒ¯æˆ–å»¶ä¼¸ï¼ˆéµç›¤æ“ä½œï¼‰
          cell.addEventListener('click', ()=> {
            if(!started){ started = true; startTimer(); }
            move(r,c,true); // true è¡¨ç¤ºè¦è¨ˆæ­¥
          });
          gridEl.appendChild(cell);
        }
      }
    }

    // å°‡ (r,c) è¨­ç‚º on/offï¼Œä¸¦åŒæ­¥æ›´æ–°å°æ‡‰ DOM å¤–è§€
    function setCell(r,c,on){
      board[r][c] = on?1:0;
      const idx = r*N + c;           // ä¸€ç¶­ç´¢å¼•ï¼ˆGrid ä»¥ row-major å„²å­˜ï¼‰
      const cell = gridEl.children[idx];
      cell.classList.toggle('on', !!on);
      cell.classList.toggle('off', !on);
    }

    // åˆ‡æ› (r,c) ç‹€æ…‹ï¼ˆè‹¥è¶Šç•Œå‰‡å¿½ç•¥ï¼‰
    function toggle(r,c){ if(r>=0 && r<N && c>=0 && c<N) setCell(r,c, !board[r][c]); }

    // é„°å±…é›†åˆï¼šè‡ªèº« + ä¸Šä¸‹å·¦å³
    function neighbors(r,c){ return [[r,c],[r-1,c],[r+1,c],[r,c-1],[r,c+1]]; }

    // æ‡‰ç”¨ä¸€æ­¥ï¼šå°è‡ªèº« + ä¸Šä¸‹å·¦å³åš toggle
    function apply(r,c){ neighbors(r,c).forEach(([rr,cc])=> toggle(rr,cc)); }

    // æ˜¯å¦å…¨éƒ¨ç‚ºæš—ï¼ˆ0ï¼‰
    function isWin(){ return board.every(row => row.every(v => v===0)); }

    // åŸ·è¡Œä¸€æ­¥ï¼ˆå¯é¸æ˜¯å¦è¨˜æ­¥ï¼‰ï¼Œä¸¦æª¢æŸ¥éé—œ
    function move(r,c, countMove){
      apply(r,c);
      if(countMove){ moves++; movesEl.textContent = moves; }
      if(isWin()) onWin();
    }

    // éé—œï¼šåœæ­¢è¨ˆæ™‚ã€æ›´æ–°è¨Šæ¯èˆ‡æœ€ä½³ç´€éŒ„
    function onWin(){
      stopTimer();
      msgEl.textContent = `ğŸ‰ æ­å–œéé—œï¼ç”¨æ™‚ ${fmtTime(timer)}ã€æ­¥æ•¸ ${moves}`;
      const b = getBest(N);
      const current = { moves, time: fmtTime(timer) };
      // è‹¥ç„¡ç´€éŒ„ï¼Œæˆ–æ›´å°‘æ­¥æ•¸ï¼›è‹¥æ­¥æ•¸ç›¸åŒå‰‡æ¯”æ™‚é–“
      if(!b || moves < b.moves || (moves===b.moves && timer < (parseInt((b.time||'0:0').split(':')[0])*60 + parseInt((b.time||'0:0').split(':')[1])))){
        setBest(N, current);
        updateBestUI();
      }
    }

    // ç”¢ç”Ÿæ–°å±€ï¼š
    // 1) å…ˆå»ºç«‹å…¨æš—ç›¤é¢ï¼›
    // 2) å¾ã€Œè§£å®Œç‹€æ…‹ã€å‡ºç™¼ï¼Œéš¨æ©Ÿå¥—ç”¨ K æ¬¡æœ‰æ•ˆæ­¥é©Ÿï¼ˆç­‰åƒ¹æ–¼äº‚æ•¸æ‰“äº‚ï¼‰ï¼Œå› æ­¤å¿…å®šå¯è§£ï¼›
    // 3) ç´€éŒ„ç‚º startBoardï¼Œä¾›é‡ç½®ç”¨ã€‚
    function newBoard(n=N){
      N=n; board = Array.from({length:N}, ()=> Array(N).fill(0));
      buildGrid();
      // K ä¾ç›¤é¢å¤§å°èˆ‡ä½¿ç”¨è€…é¸çš„äº‚åº¦è€Œå®š
      const K = Math.max(5, Math.floor((N*N) * (parseInt(densityEl.value,10)/10)));
      for(let i=0;i<K;i++){
        const r = Math.floor(Math.random()*N);
        const c = Math.floor(Math.random()*N);
        apply(r,c);
      }
      // ä¿å­˜åˆå§‹ç‹€æ…‹ï¼ˆæ·±æ‹·è²ï¼‰
      startBoard = board.map(row=> row.slice());
      moves = 0; movesEl.textContent = moves;
      timer = 0; timeEl.textContent = fmtTime(timer); started=false; stopTimer();
      msgEl.textContent = 'ç¥ä½ å¥½é‹ï¼';
      updateBestUI();
    }

    // å›å¾©åˆ°é–‹å±€ï¼šé‚„åŸ board ä¸¦åˆ·æ–° DOMã€æ¸…æ­¥æ•¸èˆ‡æ™‚é–“
    function resetToStart(){
      board = startBoard.map(row=> row.slice());
      // repaint æ‰€æœ‰æ ¼å­
      for(let r=0;r<N;r++) for(let c=0;c<N;c++) setCell(r,c, !!board[r][c]);
      moves = 0; movesEl.textContent = moves;
      timer = 0; timeEl.textContent = fmtTime(timer); started=false; stopTimer();
      msgEl.textContent = 'å·²å›åˆ°é–‹å±€ç‹€æ…‹ã€‚';
    }

    // ===== æç¤ºï¼ˆä¸€æ­¥ï¼‰ç­–ç•¥èªªæ˜ =====
    // å› ç‚ºæ–°å±€æ˜¯ç”±ã€Œè§£å®Œç‹€æ…‹ã€å‡ºç™¼ï¼Œéš¨æ©Ÿæ–½ä½œä¸€çµ„åˆæ³•æ­¥é©Ÿï¼Œæ‰€ä»¥ï¼š
    // ä»¥ä»»ä½•é †åºæŠŠã€Œé‚£äº›è¢«æ–½ä½œéçš„æ­¥é©Ÿã€å†åšä¸€æ¬¡ï¼Œå°±èƒ½å›åˆ°è§£å®Œç‹€æ…‹ã€‚
    // é€™è£¡æ¡ç”¨ç°¡å–®å•Ÿç™¼å¼ï¼šå„ªå…ˆæŒ‘ä¸€å€‹ç•¶å‰ç‚ºäº®çš„æ ¼å­ä¾†é»ã€‚
    function hintOnce(){
      const lit = [];
      for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(board[r][c]===1) lit.push([r,c]);
      const pick = lit.length? lit[Math.floor(Math.random()*lit.length)] : [Math.floor(Math.random()*N), Math.floor(Math.random()*N)];
      if(!started){ started = true; startTimer(); }
      move(pick[0], pick[1], true);
      msgEl.textContent = 'å·²å¥—ç”¨æç¤ºçš„ä¸€æ­¥ã€‚';
    }

    // ==========================
    // äº‹ä»¶ç¶å®š / Events
    // ==========================
    sizeSel.addEventListener('change', (e)=> newBoard(parseInt(e.target.value,10)) ); // æ”¹å°ºå¯¸å³æ–°å±€
    newBtn.addEventListener('click', ()=> newBoard(N));     // é‡æ–°æ´—æœ¬å°ºå¯¸
    resetBtn.addEventListener('click', resetToStart);       // å›åˆ°èµ·å§‹
    solveBtn.addEventListener('click', hintOnce);           // æç¤ºä¸€æ­¥

    // å•Ÿå‹•ï¼šä»¥é è¨­ N å»ºç«‹æ–°å±€
    newBoard(N);
  </script>
</body>
</html>
