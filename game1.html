<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lights Out｜益智小遊戲</title>
  <style>
    :root{
      --bg: #0f1221;
      --panel: #13162a;
      --text: #e8ebff;
      --muted: #9aa3c7;
      --accent: #6aa6ff;
      --accent-2: #6affde;
      --danger: #ff6a8a;
      --on: #f9f871;
      --off: #1f2341;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 10px rgba(0,0,0,.25);
      --radius: 18px;
    }
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 70% -20%, #1b2150 10%, transparent 60%),
                  radial-gradient(1000px 600px at 0% 120%, #162046 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .app{ width:min(900px, 92vw); }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:18px 22px; background: rgba(0,0,0,.15);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    h1{ font-size: clamp(20px, 2.2vw, 28px); margin:0; letter-spacing:.5px; }
    .subtitle{ color: var(--muted); font-size: 12px; margin-top:4px; }
    .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .control{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 10px; border-radius: 12px;
    }
    select, button, input[type="range"]{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background: #0f1431; color: var(--text); border:1px solid rgba(255,255,255,.12);
      padding:8px 10px; border-radius:12px; font-size:14px;
    }
    button{ cursor:pointer; transition: transform .05s ease, filter .2s ease; }
    button:active{ transform: translateY(1px); }
    .primary{ background: linear-gradient(180deg, rgba(106,166,255,.25), rgba(106,166,255,.15)); border-color:#86b8ff55; }
    .ghost{ background: transparent; border-color: rgba(255,255,255,.12); }
    .danger{ background: linear-gradient(180deg, rgba(255,106,138,.25), rgba(255,106,138,.15)); border-color:#ff9ab055; }

    .stats{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px; font-size:13px; color: #d5dcff;
    }

    main{ display:grid; grid-template-columns: 320px 1fr; gap:20px; padding:22px; }
    @media (max-width: 780px){ main{ grid-template-columns: 1fr; } }

    .left{ display:flex; flex-direction:column; gap:14px; }
    .panel{ background: var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px; }
    .panel h3{ margin:4px 0 12px; font-size:16px; color:#dbe1ff; }
    .howto ol{ margin:0 0 0 18px; padding:0; line-height:1.6; color:#c6cdee; font-size:14px; }
    .howto li+li{ margin-top:6px; }

    .grid-wrap{ display:flex; align-items:center; justify-content:center; }
    .grid{
      display:grid; gap:10px; padding:16px; border-radius:20px;
      background: radial-gradient(400px 200px at 100% -10%, rgba(106,255,222,.08), transparent 60%),
                  radial-gradient(300px 200px at -20% 120%, rgba(106,166,255,.08), transparent 60%),
                  rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
    }

    .cell{
      width: clamp(42px, 8.5vw, 64px); height: clamp(42px, 8.5vw, 64px);
      border-radius: 14px; display:grid; place-items:center; font-weight:700;
      user-select:none; -webkit-tap-highlight-color: transparent;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.2), 0 2px 6px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
      transition: transform .06s ease, filter .15s ease, background .15s ease, box-shadow .2s ease;
      cursor:pointer;
    }
    .cell:active{ transform: translateY(1px); }
    .cell.on{ background: radial-gradient(140px 100px at 50% 30%, #fff6, transparent 60%), var(--on); color:#202020; text-shadow: 0 1px 0 rgba(255,255,255,.25); }
    .cell.off{ background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.25)), var(--off); color:#92a0d8; }

    .footer{ padding:16px 22px; border-top:1px solid rgba(255,255,255,.06); display:flex; align-items:center; justify-content:space-between; gap:10px; background: rgba(0,0,0,.1); }
    .msg{ color:#cfe4ff; font-size:14px; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="app card" id="app">
    <header>
      <div>
        <h1>Lights Out｜關燈解謎</h1>
        <div class="subtitle">點擊一格會切換該格與上下左右的燈，讓版面全部關燈即獲勝。</div>
      </div>
      <div class="controls">
        <div class="control">
          <label for="size">尺寸</label>
          <select id="size">
            <option value="3">3×3</option>
            <option value="4">4×4</option>
            <option value="5" selected>5×5</option>
            <option value="6">6×6</option>
            <option value="7">7×7</option>
          </select>
        </div>
        <button id="new" class="primary">新局 / 洗牌</button>
        <button id="reset" class="ghost">回到起始</button>
        <button id="solve" class="danger">提示一步</button>
      </div>
    </header>

    <main>
      <section class="left">
        <div class="panel">
          <h3>紀錄</h3>
          <div class="stats">
            <span class="chip">步數：<b id="moves">0</b></span>
            <span class="chip">時間：<b id="time">00:00</b></span>
            <span class="chip">最佳：<b id="best">—</b></span>
          </div>
        </div>
        <div class="panel howto">
          <h3>玩法</h3>
          <ol>
            <li>點擊任一格，該格與上下左右會一起切換「亮/暗」。</li>
            <li>讓所有格子都變暗（關燈）即可過關。</li>
            <li>按「新局」可隨機產生 <em>保證可解</em> 的盤面；「回到起始」可撤銷到開局狀態。</li>
            <li>按「提示一步」會套用一個正確步驟（會計入步數）。</li>
          </ol>
        </div>
      </section>

      <section class="grid-wrap">
        <div id="grid" class="grid" role="grid" aria-label="Lights Out Grid"></div>
      </section>
    </main>

    <div class="footer">
      <div class="msg" id="msg">祝你好運！</div>
      <div style="display:flex; gap:8px; align-items:center">
        <label for="density">亂數難度</label>
        <input id="density" type="range" min="1" max="10" step="1" value="6" />
      </div>
    </div>
  </div>

  <script>
    // --- Utility ---
    const pad = (n)=> n.toString().padStart(2,'0');

    // --- Game State ---
    const gridEl = document.getElementById('grid');
    const sizeSel = document.getElementById('size');
    const newBtn = document.getElementById('new');
    const resetBtn = document.getElementById('reset');
    const solveBtn = document.getElementById('solve');
    const movesEl = document.getElementById('moves');
    const timeEl = document.getElementById('time');
    const bestEl = document.getElementById('best');
    const msgEl = document.getElementById('msg');
    const densityEl = document.getElementById('density');

    let N = parseInt(sizeSel.value, 10);
    let board = [];
    let startBoard = [];
    let moves = 0;
    let timer = 0; // seconds
    let tick = null; // interval id
    let started = false;

    const key = (n)=> `lightsout-best-${n}`;

    function getBest(n){
      try{ return JSON.parse(localStorage.getItem(key(n)) || 'null'); }catch{ return null; }
    }
    function setBest(n, val){
      try{ localStorage.setItem(key(n), JSON.stringify(val)); }catch{}
    }

    function updateBestUI(){
      const b = getBest(N);
      bestEl.textContent = b? `${b.moves}步｜${b.time}` : '—';
    }

    function fmtTime(sec){
      const m = Math.floor(sec/60), s = sec%60; return `${pad(m)}:${pad(s)}`;
    }

    function startTimer(){
      if(tick) return;
      tick = setInterval(()=>{ timer++; timeEl.textContent = fmtTime(timer); }, 1000);
    }
    function stopTimer(){ if(tick){ clearInterval(tick); tick=null; } }

    function buildGrid(){
      gridEl.innerHTML = '';
      gridEl.style.gridTemplateColumns = `repeat(${N}, 1fr)`;
      gridEl.style.gridTemplateRows = `repeat(${N}, 1fr)`;
      for(let r=0;r<N;r++){
        for(let c=0;c<N;c++){
          const cell = document.createElement('button');
          cell.className = 'cell off';
          cell.setAttribute('role','gridcell');
          cell.setAttribute('aria-label',`row ${r+1} col ${c+1}`);
          cell.dataset.r = r; cell.dataset.c = c;
          cell.addEventListener('click', ()=> {
            if(!started){ started = true; startTimer(); }
            move(r,c,true);
          });
          gridEl.appendChild(cell);
        }
      }
    }

    function setCell(r,c,on){
      board[r][c] = on?1:0;
      const idx = r*N + c;
      const cell = gridEl.children[idx];
      cell.classList.toggle('on', !!on);
      cell.classList.toggle('off', !on);
    }

    function toggle(r,c){ if(r>=0 && r<N && c>=0 && c<N) setCell(r,c, !board[r][c]); }

    function neighbors(r,c){ return [[r,c],[r-1,c],[r+1,c],[r,c-1],[r,c+1]]; }

    function apply(r,c){ neighbors(r,c).forEach(([rr,cc])=> toggle(rr,cc)); }

    function isWin(){ return board.every(row => row.every(v => v===0)); }

    function move(r,c, countMove){
      apply(r,c);
      if(countMove){ moves++; movesEl.textContent = moves; }
      if(isWin()) onWin();
    }

    function onWin(){
      stopTimer();
      msgEl.textContent = `🎉 恭喜過關！用時 ${fmtTime(timer)}、步數 ${moves}`;
      const b = getBest(N);
      const current = { moves, time: fmtTime(timer) };
      if(!b || moves < b.moves || (moves===b.moves && timer < (parseInt((b.time||'0:0').split(':')[0])*60 + parseInt((b.time||'0:0').split(':')[1])))){
        setBest(N, current);
        updateBestUI();
      }
    }

    function newBoard(n=N){
      N=n; board = Array.from({length:N}, ()=> Array(N).fill(0));
      buildGrid();
      // Randomize by applying K random valid moves from the solved state => guaranteed solvable
      const K = Math.max(5, Math.floor((N*N) * (parseInt(densityEl.value,10)/10)));
      for(let i=0;i<K;i++){
        const r = Math.floor(Math.random()*N);
        const c = Math.floor(Math.random()*N);
        apply(r,c);
      }
      // Save as start state for reset
      startBoard = board.map(row=> row.slice());
      moves = 0; movesEl.textContent = moves;
      timer = 0; timeEl.textContent = fmtTime(timer); started=false; stopTimer();
      msgEl.textContent = '祝你好運！';
      updateBestUI();
    }

    function resetToStart(){
      board = startBoard.map(row=> row.slice());
      // repaint
      for(let r=0;r<N;r++) for(let c=0;c<N;c++) setCell(r,c, !!board[r][c]);
      moves = 0; movesEl.textContent = moves;
      timer = 0; timeEl.textContent = fmtTime(timer); started=false; stopTimer();
      msgEl.textContent = '已回到開局狀態。';
    }

    // Optional: one-step hint by reverting a random lit cell with its move parity.
    // Simple strategy: pick any lit cell, click it (works because from solved we created
    // the puzzle via random valid moves; applying the same set in any order solves it).
    function hintOnce(){
      // Pick a random position and apply; heuristic: prioritize cells that are "on"
      const lit = [];
      for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(board[r][c]===1) lit.push([r,c]);
      const pick = lit.length? lit[Math.floor(Math.random()*lit.length)] : [Math.floor(Math.random()*N), Math.floor(Math.random()*N)];
      if(!started){ started = true; startTimer(); }
      move(pick[0], pick[1], true);
      msgEl.textContent = '已套用提示的一步。';
    }

    // --- Events ---
    sizeSel.addEventListener('change', (e)=> newBoard(parseInt(e.target.value,10)) );
    newBtn.addEventListener('click', ()=> newBoard(N));
    resetBtn.addEventListener('click', resetToStart);
    solveBtn.addEventListener('click', hintOnce);

    // Initialize
    newBoard(N);
  </script>
</body>
</html>
